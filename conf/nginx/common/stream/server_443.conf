# 什么时候必须加 reuseport？只有在你的最外层入口（即直接暴露给公网的端口）建议加上，内部回环（Loopback）不需要加，加了反而有CPU消耗
# TCP (HTTPS/1.1 & H2)
server {
    listen 443 reuseport so_keepalive=on;
    listen [::]:443 reuseport so_keepalive=on;

    proxy_pass $backend_name_443;

    # 【全局开启】把真 IP 传给所有人！
    # 即使 FRP 不支持，我们也先发出去，由下一步的清洗层处理
    proxy_protocol on;

    # 开启预读ssl功能 $ssl_preread_server_name
    ssl_preread on;
    # 这里放一个通用的、较宽松的配置（外部转发配置）
    include /common/stream/server/proxy_external.conf;
}

# --- UDP 443 监听 (处理 HTTP/3 QUIC) ---
# UDP 不支持 PROXY 协议：在 Nginx 的 stream 模块中，对 UDP 开启 proxy_protocol 会导致包头被破坏，QUIC 握手直接失败
server {
    listen 443 udp reuseport;
    listen [::]:443 udp reuseport;

    proxy_pass $backend_name_443_to_internal;

    # 开启预读ssl功能 $ssl_preread_server_name
    ssl_preread on;
    # 这里放一个通用的、较宽松的配置（外部转发配置）
    include /common/stream/server/proxy_external.conf;
}

# 需要用到 proxy_internal.conf，所以加上中间层
server {
    listen unix:/dev/shm/docker_443_to_internal.sock so_keepalive=on proxy_protocol;

    # 信任本地转发
    set_real_ip_from 127.0.0.1;

    proxy_pass $backend_name_443_to_internal;

    # 在连接时“塞入”真实 IP 报头
    # 后续nginx的端口监听必须加上 listen ... proxy_protocol
    proxy_protocol on;

    # 开启预读ssl功能 $ssl_preread_server_name
    ssl_preread on;

    # 载入公共配置 转发给本地 Web 端 代理
    include /common/stream/server/proxy_internal.conf;
}
