# 如果有请求通过 IP 地址或未定义的域名直接访问这个端口，Nginx 会在 TLS 握手阶段直接拒绝
# 防止黑客通过扫描 IP 地址获取你的 SSL 证书信息。对方看到的不是“403 错误”，而是“连接被重置”，这能有效隐藏你的服务器真实用途
server {
    listen 127.0.0.1:8001 ssl default_server proxy_protocol;
    http2 on;
    # 开启 http3 接收来自 443 UDP 的直连流量
    listen 127.0.0.1:8001 quic;
    ssl_reject_handshake on;
}

server {
    listen 127.0.0.1:8001 ssl proxy_protocol;
    http2 on;
    # 开启 http3 接收来自 443 UDP 的直连流量
    listen 127.0.0.1:8001 quic;

    # 信任本地转发
    set_real_ip_from  127.0.0.1;
    # 从 PROXY 协议中提取真 IP 覆盖到 $remote_addr
    real_ip_header proxy_protocol;

    server_name .20250618.xyz .20300808.xyz .rens.cc .jobuse.cn;

    # 1. 指定 ECDH 曲线，将 X25519 放在首位
    # X25519 是目前公认最快、最安全的曲线之一
    ssl_ecdh_curve X25519:P-256:P-384;
    # 确保开启了服务器偏好（虽然 TLS 1.3 会自动协商，但显式开启更稳）
    ssl_prefer_server_ciphers on;

    # 强制浏览器在未来的一年（31536000 秒）内，必须通过 HTTPS 访问你的网站，防御攻击： 中间人攻击 (MITM) 和 SSL 剥离
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    # 控制你的网站是否允许被嵌入到 <iframe> 中，防御攻击： 点击劫持 (Clickjacking)
    add_header X-Frame-Options "SAMEORIGIN";
    # 禁用浏览器的 MIME 类型嗅探，防御攻击： 跨站脚本攻击 (XSS) 和 恶意文件执行
    add_header X-Content-Type-Options "nosniff";
    # 在 server 块中添加 Alt-Svc 头部，通知浏览器支持 HTTP/3
    add_header Alt-Svc 'h3=":443"; ma=86400';

    # 开启了 TLS 1.3 的 0-RTT 特性，减少握手延迟，让访问速度更快
    ssl_early_data on;
    ssl_certificate /conf/ag.pem;
    ssl_certificate_key /conf/ag.key;
    ssl_ciphers TLS13_AES_128_GCM_SHA256:TLS13_AES_256_GCM_SHA384:TLS13_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;

    ssl_session_tickets        on;
    ssl_stapling off;
    ssl_stapling_verify off;

    # 指定静态资源根目录
    root /www/COLOR;
    index index.html index.htm;

    # 开启 Gzip 压缩：显著减少 CSS、JS、HTML 的传输体积
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    location / {
        try_files $uri $uri/ =404;

        # 允许 TLS 1.3 0-RTT 头部，让前端感知性能优化
        add_header Early-Data $ssl_early_data;
        # 开启 TCP 优化：数据包攒够了再发，减少碎片
        tcp_nodelay on;
        tcp_nopush on;
    }

    # 静态资源强缓存：图片、字体、视频等不常变动的内容
    # 让浏览器直接从本地硬盘读取，不再请求服务器
    location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|eot|otf|ttf|svg|mp4|webm)$ {
        expires 30d;           # 缓存 30 天
        add_header Cache-Control "public, no-transform";
        access_log off;        # 关闭这些静态资源的访问日志，减少磁盘 IO
    }

    # 针对 HTML 开启协商缓存：保证页面更新能及时生效
    location ~* \.(?:html|htm)$ {
        add_header Cache-Control "no-cache, must-revalidate";
    }
}

# 如果有请求通过 IP 地址或未定义的域名直接访问这个端口，Nginx 会在 TLS 握手阶段直接拒绝
# 防止黑客通过扫描 IP 地址获取你的 SSL 证书信息。对方看到的不是“403 错误”，而是“连接被重置”，这能有效隐藏你的服务器真实用途
server {
    listen 127.0.0.1:8002 ssl default_server proxy_protocol;
    http2 on;
    # 开启 http3 接收来自 443 UDP 的直连流量
    listen 127.0.0.1:8002 quic;
    ssl_reject_handshake on;
}

server {
    listen 127.0.0.1:8002 ssl proxy_protocol;
    http2 on;
    # 开启 http3 接收来自 443 UDP 的直连流量
    listen 127.0.0.1:8002 quic;

    # 信任本地转发
    set_real_ip_from  127.0.0.1;
    # 从 PROXY 协议中提取真 IP 覆盖到 $remote_addr
    real_ip_header proxy_protocol;

    server_name .20250618.xyz .20300808.xyz .rens.cc .jobuse.cn;

    # 1. 指定 ECDH 曲线，将 X25519 放在首位
    # X25519 是目前公认最快、最安全的曲线之一
    ssl_ecdh_curve X25519:P-256:P-384;
    # 确保开启了服务器偏好（虽然 TLS 1.3 会自动协商，但显式开启更稳）
    ssl_prefer_server_ciphers on;

    # 强制浏览器在未来的一年（31536000 秒）内，必须通过 HTTPS 访问你的网站，防御攻击： 中间人攻击 (MITM) 和 SSL 剥离
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    # 控制你的网站是否允许被嵌入到 <iframe> 中，防御攻击： 点击劫持 (Clickjacking)
    add_header X-Frame-Options "SAMEORIGIN";
    # 禁用浏览器的 MIME 类型嗅探，防御攻击： 跨站脚本攻击 (XSS) 和 恶意文件执行
    add_header X-Content-Type-Options "nosniff";
    # 在 server 块中添加 Alt-Svc 头部，通知浏览器支持 HTTP/3
    add_header Alt-Svc 'h3=":443"; ma=86400';

    # 开启了 TLS 1.3 的 0-RTT 特性，减少握手延迟，让访问速度更快
    ssl_early_data on;
    ssl_certificate /conf/ag.pem;
    ssl_certificate_key /conf/ag.key;
    ssl_ciphers TLS13_AES_128_GCM_SHA256:TLS13_AES_256_GCM_SHA384:TLS13_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305;

    # 运行时解析（动态）： proxy_pass 中使用了变量，Nginx 就必须在每次请求时或者根据缓存时间去动态解析域名。
    # 这种情况下，如果不配置 resolver，Nginx 会直接报错无法工作
    # 如果 proxy_pass 没有使用变量，Nginx 只会在启动或重载配置时解析一次域名
    resolver 127.0.0.1 8.8.8.8 223.5.5.5 valid=60s;
    resolver_timeout 2s;

    ssl_session_tickets        on;
    ssl_stapling off;
    ssl_stapling_verify off;

    location / {
        # 将响应内容中的源域名替换为你的域名，防止用户点击网页链接时跳转回原始网站
        sub_filter $proxy_host $host;
        sub_filter_once off;

        # 只有定义了变量，才能使用resolver动态解析dns，不需要重启 nginx -s reload
        set $website www.lovelive-anime.jp;
        proxy_pass https://$website;

        proxy_set_header Host                 $proxy_host;
        proxy_http_version                    1.1;
        proxy_cache_bypass                    $http_upgrade;
        proxy_ssl_server_name                 on;
        proxy_set_header Upgrade              $http_upgrade;
        proxy_set_header Connection           $connection_upgrade;
        proxy_set_header X-Real-IP            $proxy_protocol_addr;
        proxy_set_header Forwarded            $proxy_add_forwarded;
        proxy_set_header X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto    $scheme;
        proxy_set_header X-Forwarded-Host     $host;
        proxy_set_header X-Forwarded-Port     $server_port;
        proxy_connect_timeout                 60s;
        proxy_send_timeout                    60s;
        proxy_read_timeout                    60s;
        proxy_set_header Early-Data           $ssl_early_data;
    }
}